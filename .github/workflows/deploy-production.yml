name: Deploy Production

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  check-vercel:
    name: Check Vercel Configuration
    runs-on: ubuntu-latest
    outputs:
      configured: ${{ steps.check.outputs.configured }}
    steps:
      - name: Check for Vercel secrets
        id: check
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ] && [ -n "${{ secrets.VERCEL_ORG_ID }}" ] && [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::Vercel deployment skipped - VERCEL_TOKEN, VERCEL_ORG_ID, or VERCEL_PROJECT_ID not configured"
          fi

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: check-vercel
    if: needs.check-vercel.outputs.configured == 'true'
    permissions:
      contents: read
    environment:
      name: production
      url: https://lusk.app
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Production
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

  sentry-release:
    name: Create Sentry Release
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always() && needs.deploy-production.result == 'success'
    permissions:
      contents: read
    steps:
      - name: Check for Sentry secrets
        id: check-sentry
        run: |
          if [ -n "${{ secrets.SENTRY_AUTH_TOKEN }}" ] && [ -n "${{ secrets.SENTRY_ORG }}" ] && [ -n "${{ secrets.SENTRY_PROJECT }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::Sentry release skipped - SENTRY_AUTH_TOKEN, SENTRY_ORG, or SENTRY_PROJECT not configured"
          fi

      - name: Checkout
        if: steps.check-sentry.outputs.configured == 'true'
        uses: actions/checkout@v6

      - name: Create Sentry Release
        if: steps.check-sentry.outputs.configured == 'true'
        uses: getsentry/action-release@v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
